<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Chat Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 16px; }
    .row { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
    #log { border: 1px solid #ddd; height: 55vh; overflow: auto; padding: 8px; margin-top: 8px; }
    input, button { padding: 8px; }
  </style>
</head>
<body>
  <h1>Chat (room: general)</h1>

  <div class="row">
    <input id="username" placeholder="username" />
    <input id="email" placeholder="email" />
    <input id="password" type="password" placeholder="password" />
    <button id="register">Register</button>
    <input id="loginId" placeholder="username or email" />
    <input id="loginPass" type="password" placeholder="password" />
    <button id="login">Login</button>
  </div>

  <div class="row">
    <button id="loadHistory">Load History</button>
    <button id="join">Join Room</button>
  </div>

  <div id="log"></div>

  <div class="row">
    <input id="message" placeholder="Type a message..." style="flex:1;" />
    <button id="send">Send</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);
    let token = null;
    let socket = null;

    const log = (m) => {
      const div = document.createElement('div');
      div.textContent = m;
      $('log').appendChild(div);
      $('log').scrollTop = $('log').scrollHeight;
    };

    $('register').onclick = async () => {
      const r = await fetch('/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: $('username').value, email: $('email').value, password: $('password').value })
      });
      const data = await r.json();
      if (r.ok) {
        token = data.token;
        log('Registered ✓');
      } else {
        log('Register error: ' + (data.error || r.status));
      }
    };

    $('login').onclick = async () => {
      const r = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ usernameOrEmail: $('loginId').value, password: $('loginPass').value })
      });
      const data = await r.json();
      if (r.ok) {
        token = data.token;
        log('Logged in ✓');
        connectSocket();
      } else {
        log('Login error: ' + (data.error || r.status));
      }
    };

    function connectSocket() {
      socket = io('/', { auth: { token } });
      socket.on('connect', () => log('Socket connected'));
      socket.on('message', (msg) => log(`[${new Date(msg.createdAt).toLocaleTimeString()}] ${msg.room ? '#'+msg.room : ''} ${msg.from} : ${msg.content}`));
      socket.on('connect_error', (e) => log('Socket error: ' + e.message));
    }

    $('join').onclick = () => {
      if (!socket) return log('Login first');
      socket.emit('joinRoom', 'general');
      log('Joined room: general');
    };

    $('send').onclick = () => {
      if (!socket) return log('Login first');
      const content = $('message').value;
      if (!content) return;
      socket.emit('sendMessage', { content, room: 'general' }, (res) => {
        if (!res.ok) log('Send error: ' + res.error);
      });
      $('message').value = '';
    };

    $('loadHistory').onclick = async () => {
      if (!token) return log('Login first');
      const r = await fetch('/api/messages?room=general&limit=50', { headers: { Authorization: `Bearer ${token}` } });
      const data = await r.json();
      if (r.ok) {
        log('— History —');
        data.forEach(m => log(`[${new Date(m.createdAt).toLocaleTimeString()}] #general ${m.from} : ${m.content}`));
        log('———————');
      } else {
        log('History error: ' + (data.error || r.status));
      }
    };
  </script>
</body>
</html>